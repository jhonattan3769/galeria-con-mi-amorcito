<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galería con mi amorcito</title>
    <style>
        /* --- INICIO DE NUEVOS ESTILOS - Estilo Scrapbook --- */

        @import url('https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Poppins:wght@300;400&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            text-align: center;
            background-color: #AEC6CF; /* Color de fondo tipo papel */
            color: #00008B;
            margin: 0;
            padding: 40px 20px;
            font-weight: 300;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background-color: transparent; /* Hacemos el contenedor transparente */
            padding: 10px;
            border-radius: 0;
            box-shadow: none; /* Quitamos la sombra del contenedor */
        }

        h1 {
            font-family: 'Kalam', cursive; /* Fuente tipo "hecha a mano" */
            font-weight: 700;
            color: #00008B;
            font-size: 3.5em;
        }
        h2 {
            font-family: 'Kalam', cursive;
            font-weight: 400;
            font-size: 2em;
            margin-top: 30px;
        }
        p {
            font-size: 1.1em;
        }

        /* Estilo del formulario de subida */
        #upload-form {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #c9c0aa;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* Estilo de la "Página" del libro */
        #gallery {
            position: relative; /* ¡MUY IMPORTANTE! */
            width: 100%;
            height: 800px; /* Altura fija para nuestra "página" */
            background: #fffdf7; /* Color de página de libro */
            border: 1px solid #ddd;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden; /* Oculta lo que se salga */
        }

        /* Estilo de cada foto (tipo polaroid) */
        .gallery-item {
            position: absolute; /* ¡LA CLAVE! Se posicionarán aleatoriamente */
            background: white;
            padding: 10px 10px 20px 10px; /* Espacio para el marco */
            border-radius: 3px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .gallery-item:hover {
            transform: scale(1.1) !important; /* Hacemos zoom (importante para sobreescribir el JS) */
            box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
            z-index: 10 !important; /* Se pone por encima de las otras */
        }

        .gallery-img {
            width: 180px; /* Tamaño base de la foto */
            height: 180px;
            object-fit: cover;
            cursor: pointer;
        }

        .delete-btn {
            position: absolute;
            top: -10px; /* Lo ponemos por fuera del marco */
            right: -10px;
            background-color: #ff6b6b;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }

        .gallery-item:hover .delete-btn {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Estilos de los botones de paginación */
        .pagination {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-btn {
            font-family: 'Poppins', sans-serif;
            background-color: #8d7b68;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .nav-btn:hover {
            background-color: #6a5c4d;
        }
        .nav-btn:disabled {
            background-color: #c9c0aa;
            cursor: not-allowed;
        }
        #page-info {
            font-family: 'Kalam', cursive;
            font-size: 1.5em;
            color: #333;
        }

        /* Estilos del Modal (Lightbox) */
        .modal {
            display: none; position: fixed; z-index: 1000;
            padding-top: 60px; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            margin: auto; display: block; width: 80%; max-width: 700px;
            animation-name: zoom; animation-duration: 0.6s;
        }
        @keyframes zoom { from {transform:scale(0)} to {transform:scale(1)} }
        .close {
            position: absolute; top: 15px; right: 35px;
            color: #f1f1f1; font-size: 40px; font-weight: bold;
            transition: 0.3s; cursor: pointer;
        }
        .close:hover, .close:focus { color: #bbb; }
        /* --- FIN DE LOS NUEVOS ESTILOS --- */
    </style>
</head>
<body>

    <div class="container">
        <h1>¡Galería con mi amorcito!</h1>
        <p>Esta galería la cree con el fin de preservar nuestros mejores recuerdos</p>

        <div id="upload-container">
            <h3>¡Sube el recuerdo aquí!</h3>
            <form id="upload-form">
                <input type="file" id="photo-input" name="photo" accept="image/*" required>
                <button type="submit">Compartir Foto</button>
            </form>
        </div>

        <h2>Galería de Recuerdos</h2>
        <div id="gallery">
            </div>

        <div class="pagination">
            <button id="prev-page" class="nav-btn">Página Anterior</button>
            <span id="page-info"></span>
            <button id="next-page" class="nav-btn">Página Siguiente</button>
        </div>

    </div> <div id="myModal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="img01">
    </div>

    <script>
        // --- INICIO DEL NUEVO JAVASCRIPT ---

        // Elementos del DOM
        const uploadForm = document.getElementById('upload-form');
        const photoInput = document.getElementById('photo-input');
        const gallery = document.getElementById('gallery');
        const modal = document.getElementById("myModal"); // Ahora sí lo encuentra
        const modalImg = document.getElementById("img01"); // Ahora sí lo encuentra
        const span = document.getElementsByClassName("close")[0]; // Ahora sí lo encuentra
        const prevPageBtn = document.getElementById('prev-page'); // Ahora sí lo encuentra
        const nextPageBtn = document.getElementById('next-page'); // Ahora sí lo encuentra
        const pageInfo = document.getElementById('page-info'); // Ahora sí lo encuentra

        // URL del servidor
        const API_URL = 'https://galeria-con-mi-amorcito.onrender.com';

        // Estado de la galería
        let allPhotos = [];
        let currentPage = 1;
        const photosPerPage = 6; // Fotos por "página" del libro
        let totalPages = 1;

        // --- FUNCIÓN PARA MOSTRAR LA PÁGINA ACTUAL ---
        function displayPage(page) {
            gallery.innerHTML = ''; // Limpiamos la página
            currentPage = page;

            // Calculamos el total de páginas
            totalPages = Math.ceil(allPhotos.length / photosPerPage);
            if (totalPages === 0) totalPages = 1;

            // Actualizamos la información de la página
            pageInfo.textContent = `Página ${currentPage} / ${totalPages}`;

            // Habilitamos o deshabilitamos botones de navegación
            prevPageBtn.disabled = (currentPage === 1);
            nextPageBtn.disabled = (currentPage === totalPages);

            // Calculamos qué fotos mostrar
            const startIndex = (page - 1) * photosPerPage;
            const endIndex = startIndex + photosPerPage;
            const photosToShow = allPhotos.slice(startIndex, endIndex);

            // Añadimos cada foto con un estilo aleatorio
            photosToShow.forEach(photoPath => {
                addImageToGallery(photoPath);
            });
        }

        // --- FUNCIÓN PARA AÑADIR UNA FOTO (MODIFICADA) ---
        function addImageToGallery(imagePath) {
            const filename = imagePath.split('/').pop();
            const container = document.createElement('div');
            container.classList.add('gallery-item');

            const newImage = document.createElement('img');
            newImage.src = imagePath;
            newImage.alt = 'Recuerdo';
            newImage.classList.add('gallery-img');
            newImage.onclick = () => openModal(imagePath);

            const deleteButton = document.createElement('button');
            deleteButton.innerText = 'X';
            deleteButton.classList.add('delete-btn');
            deleteButton.onclick = () => deletePhoto(filename, container);

            container.appendChild(newImage);
            container.appendChild(deleteButton);

            // --- LA MAGIA DEL ESTILO ASIMÉTRICO ---
            const randomRotate = Math.random() * 20 - 10; // -10 a +10 grados
            const randomTop = Math.random() * 65 + 5;     // 5% a 70% desde arriba
            const randomLeft = Math.random() * 65 + 5;    // 5% a 70% desde la izquierda
            const randomZIndex = Math.floor(Math.random() * 5); // Para que se superpongan

            container.style.transform = `rotate(${randomRotate}deg)`;
            container.style.top = `${randomTop}%`;
            container.style.left = `${randomLeft}%`;
            container.style.zIndex = randomZIndex;

            gallery.appendChild(container); // Usamos appendChild en lugar de prepend
        }

        // --- FUNCIÓN PARA CARGAR LAS FOTOS AL INICIO (MODIFICADA) ---
        async function loadInitialPhotos() {
            try {
                const response = await fetch(`${API_URL}/photos`);
                allPhotos = await response.json(); // Guardamos las fotos en nuestro array
                displayPage(1); // Mostramos la primera página
            } catch (error) {
                console.error('Error al cargar las fotos:', error);
            }
        }

        // --- FUNCIÓN PARA SUBIR LA FOTO (MODIFICADA) ---
        uploadForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const file = photoInput.files[0];
            if (!file) { alert('Por favor, selecciona una foto.'); return; }
            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    alert('¡Recuerdo subido con éxito!');
                    allPhotos.unshift(result.filePath); // Añadimos la nueva foto al inicio del array
                    displayPage(1); // Volvemos a la página 1 para verla
                    uploadForm.reset();
                } else {
                    alert('Hubo un error al subir la foto.');
                }
            } catch (error) {
                alert('No se pudo conectar con el servidor.');
            }
        });

        // --- FUNCIÓN PARA ELIMINAR FOTOS (MODIFICADA) ---
        async function deletePhoto(filename, containerElement) {
            const password = prompt("Para eliminar el recuerdo, ingresa la contraseña:");
            if (!password) return;

            try {
                const response = await fetch(`${API_URL}/delete/${filename}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Recuerdo eliminado.');
                    // Recargamos la lista de fotos desde el servidor
                    loadInitialPhotos();
                } else {
                    alert('Error al eliminar: ' + result.message);
                }
            } catch (error) {
                alert('No se pudo conectar con el servidor.');
            }
        }

        // --- LÓGICA DE NAVEGACIÓN Y MODAL ---
        prevPageBtn.onclick = () => {
            if (currentPage > 1) {
                displayPage(currentPage - 1);
            }
        };
        nextPageBtn.onclick = () => {
            if (currentPage < totalPages) {
                displayPage(currentPage + 1);
            }
        };

        function openModal(imageSrc) {
            modal.style.display = "block";
            modalImg.src = imageSrc;
        }
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Carga inicial
        window.onload = loadInitialPhotos;
        // --- FIN DEL NUEVO JAVASCRIPT ---
    </script>

</body>
</html>
